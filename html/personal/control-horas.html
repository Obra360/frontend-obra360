<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
  <title>Control de Horas - Obra 360</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/src/app.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>

<body>
  <script src="/src/js/auth.js"></script>

  <div class="wrapper">
    <nav class="sidebar js-sidebar" id="sidebar">
      <div class="sidebar-content js-simplebar">
        <a class="sidebar-brand" href="/index.html">
          <span class="align-middle">Obra 360</span>
        </a>
        <ul class="sidebar-nav">
          <li class="sidebar-header">Secciones</li>

          <!-- Inicio -->
          <li class="sidebar-item">
            <a class="sidebar-link" href="/index.html">
              <i class="align-middle" data-feather="sliders"></i>
              <span class="align-middle">Inicio</span>
            </a>
          </li>

          <!-- Obras -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-obras" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="home"></i>
              <span class="align-middle">Obras</span>
            </a>
            <ul id="submenu-obras" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/obras/obras.html">Listado de obras</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/obras/nueva-obra.html">Nueva obra</a>
              </li>
            </ul>
          </li>

          <!-- Materiales -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-materiales" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="box"></i>
              <span class="align-middle">Materiales</span>
            </a>
            <ul id="submenu-materiales" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/materiales/materiales.html">Listado de materiales</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/materiales/nuevo-material.html">Nuevo material</a>
              </li>
            </ul>
          </li>

          <!-- Certificaciones -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-certificaciones" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="file-text"></i>
              <span class="align-middle">Certificaciones</span>
            </a>
            <ul id="submenu-certificaciones" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/certificaciones/certificaciones.html">Alta de certificación</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/certificaciones/certificaciones-nueva.html">Nueva certificación</a>
              </li>
            </ul>
          </li>

          <!-- Personal -->
          <li class="sidebar-item active">
            <a data-bs-target="#submenu-personal" data-bs-toggle="collapse" class="sidebar-link">
              <i class="align-middle" data-feather="users"></i>
              <span class="align-middle">Personal</span>
            </a>
            <ul id="submenu-personal" class="sidebar-dropdown list-unstyled collapse show" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/personal/personal.html">Listado de personal</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/personal/nuevo-personal.html">Nuevo ingreso</a>
              </li>
              <li class="sidebar-item active">
                <a class="sidebar-link" href="/html/personal/control-horas.html">Control de horas</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <div class="main">
      <nav class="navbar navbar-expand navbar-light navbar-bg">
        <a class="sidebar-toggle js-sidebar-toggle">
          <i class="hamburger align-self-center"></i>
        </a>
        <div class="navbar-collapse collapse">
          <ul class="navbar-nav navbar-align">
            <li class="nav-item dropdown">
              <a class="nav-icon dropdown-toggle" data-bs-toggle="dropdown" href="#" id="alertsDropdown">
                <div class="position-relative">
                  <i class="align-middle" data-feather="bell"></i>
                  <span class="indicator">0</span>
                </div>
              </a>
              <div aria-labelledby="alertsDropdown" class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0">
                <div class="dropdown-menu-header">Sin notificaciones</div>
                <div class="dropdown-menu-footer">
                  <a class="text-muted" href="#">Ver todas las notificaciones</a>
                </div>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" data-bs-toggle="dropdown" href="#">
                <i class="align-middle" data-feather="settings"></i>
              </a>
              <a class="nav-link dropdown-toggle d-none d-sm-inline-block" data-bs-toggle="dropdown" href="#">
                <span class="text-dark" id="userName">Usuario</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item" href="pages-profile.html">
                  <i class="align-middle me-1" data-feather="user"></i>
                  Profile
                </a>
                <a class="dropdown-item" href="#">
                  <i class="align-middle me-1" data-feather="pie-chart"></i>
                  Analytics
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/index.html">
                  <i class="align-middle me-1" data-feather="settings"></i>
                  Settings &amp; Privacy
                </a>
                <a class="dropdown-item" href="#">
                  <i class="align-middle me-1" data-feather="help-circle"></i>
                  Help Center
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" onclick="logout()">
                  <i class="align-middle me-1" data-feather="log-out"></i>
                  Cerrar Sesión
                </a>
              </div>
            </li>
          </ul>
        </div>
      </nav>

      <main class="content">
        <div class="container-fluid p-0">
          <!-- Header con resumen del día -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                  <div class="row align-items-center">
                    <div class="col-md-6">
                      <h1 class="mb-2">
                        <i class="bi bi-clock-history me-2"></i>Control de Horas
                      </h1>
                      <p class="mb-0 opacity-75">Gestión de asistencia y horarios del personal</p>
                    </div>
                    <div class="col-md-6">
                      <div class="row text-center">
                        <div class="col-4">
                          <div class="fs-2 fw-bold" id="empleadosPresentes">0</div>
                          <div class="small opacity-75">Presentes hoy</div>
                        </div>
                        <div class="col-4">
                          <div class="fs-2 fw-bold" id="horasTotales">0</div>
                          <div class="small opacity-75">Horas trabajadas</div>
                        </div>
                        <div class="col-4">
                          <div class="fs-2 fw-bold" id="horasExtra">0</div>
                          <div class="small opacity-75">Horas extra</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Controles principales -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-end">
                    <!-- Filtro por fecha -->
                    <div class="col-md-3">
                      <label class="form-label">
                        <i class="bi bi-calendar me-1"></i>Fecha
                      </label>
                      <input type="date" class="form-control" id="fechaFiltro">
                    </div>
                    
                    <!-- Filtro por empleado -->
                    <div class="col-md-3">
                      <label class="form-label">
                        <i class="bi bi-person me-1"></i>Empleado
                      </label>
                      <select class="form-select" id="empleadoFiltro">
                        <option value="">Todos los empleados</option>
                      </select>
                    </div>

                    <!-- Botones de acción -->
                    <div class="col-md-6">
                      <div class="btn-group me-2" role="group">
                        <button class="btn btn-primary" onclick="mostrarModalRegistro()">
                          <i class="bi bi-clock me-1"></i>Registrar Entrada/Salida
                        </button>
                        <button class="btn btn-success" onclick="exportarExcel()">
                          <i class="bi bi-file-earmark-excel me-1"></i>Exportar Excel
                        </button>
                        <button class="btn btn-info" onclick="actualizarDatos()">
                          <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de asistencia -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="bi bi-table me-2"></i>Planilla de Asistencia
                  </h5>
                </div>
                
                <div class="card-body p-0">
                  <!-- Contenedor de alertas -->
                  <div id="alertContainer" class="px-3 pt-3"></div>
                  
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead class="table-dark">
                        <tr>
                          <th class="px-3">
                            <i class="bi bi-person me-1"></i>Empleado
                          </th>
                          <th class="text-center">
                            <i class="bi bi-calendar me-1"></i>Fecha
                          </th>
                          <th class="text-center">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Hora Ingreso
                          </th>
                          <th class="text-center">
                            <i class="bi bi-box-arrow-left me-1"></i>Hora Egreso
                          </th>
                          <th class="text-center">
                            <i class="bi bi-clock me-1"></i>Horas Normales
                          </th>
                          <th class="text-center">
                            <i class="bi bi-clock-fill me-1"></i>Horas Extra
                          </th>
                          <th class="text-center">
                            <i class="bi bi-calculator me-1"></i>Total Horas
                          </th>
                          <th class="text-center">
                            <i class="bi bi-gear me-1"></i>Acciones
                          </th>
                        </tr>
                      </thead>
                      <tbody id="tablaAsistencia">
                        <tr>
                          <td colspan="8" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando registros de asistencia...</p>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container-fluid">
          <div class="row text-muted">
            <div class="col-6 text-start">
              <p class="mb-0">
                <a class="text-muted" target="_blank">
                  <strong>Obra 360</strong>
                </a>
                -
                <a class="text-muted" target="_blank">
                  <strong>Admin Kit</strong>
                </a>
                ©
              </p>
            </div>
            <div class="col-6 text-end">
              <ul class="list-inline">
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Soporte</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Centro de ayuda</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Privacidad</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Términos</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal para registrar entrada/salida -->
  <div class="modal fade" id="registroModal" tabindex="-1" aria-labelledby="registroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registroModalLabel">
            <i class="bi bi-clock-history text-primary me-2"></i>Registrar Entrada/Salida
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Contenedor de alertas del modal -->
          <div id="modalAlertContainer"></div>
          
          <form id="registroForm">
            <div class="row">
              <div class="col-12 mb-3">
                <label for="registroEmpleado" class="form-label">
                  <i class="bi bi-person me-1"></i>Empleado *
                </label>
                <select class="form-select" id="registroEmpleado" required>
                  <option value="">Seleccionar empleado</option>
                </select>
                <div class="invalid-feedback">Debe seleccionar un empleado.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="registroFecha" class="form-label">
                  <i class="bi bi-calendar me-1"></i>Fecha *
                </label>
                <input type="date" class="form-control" id="registroFecha" required>
                <div class="invalid-feedback">La fecha es requerida.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="tipoRegistro" class="form-label">
                  <i class="bi bi-toggle-on me-1"></i>Tipo de Registro *
                </label>
                <select class="form-select" id="tipoRegistro" required>
                  <option value="">Seleccionar tipo</option>
                  <option value="entrada">Entrada</option>
                  <option value="salida">Salida</option>
                </select>
                <div class="invalid-feedback">Debe seleccionar el tipo.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="registroHora" class="form-label">
                  <i class="bi bi-clock me-1"></i>Hora *
                </label>
                <input type="time" class="form-control" id="registroHora" required>
                <div class="invalid-feedback">La hora es requerida.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <i class="bi bi-info-circle me-1"></i>Hora Actual
                </label>
                <div class="form-control-plaintext fw-bold text-primary" id="horaActual">
                  --:--:--
                </div>
              </div>
              
              <div class="col-12">
                <label for="observaciones" class="form-label">
                  <i class="bi bi-chat-text me-1"></i>Observaciones
                </label>
                <textarea class="form-control" id="observaciones" rows="2" placeholder="Observaciones adicionales (opcional)"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarRegistro">
            <i class="bi bi-check-lg me-1"></i>Registrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar registro -->
  <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarModalLabel">
            <i class="bi bi-pencil text-warning me-2"></i>Editar Registro
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Contenedor de alertas del modal -->
          <div id="editModalAlertContainer"></div>
          
          <form id="editarForm">
            <input type="hidden" id="editRegistroId">
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editHoraEntrada" class="form-label">
                  <i class="bi bi-box-arrow-in-right me-1"></i>Hora Entrada
                </label>
                <input type="time" class="form-control" id="editHoraEntrada">
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="editHoraSalida" class="form-label">
                  <i class="bi bi-box-arrow-left me-1"></i>Hora Salida
                </label>
                <input type="time" class="form-control" id="editHoraSalida">
              </div>
              
              <div class="col-12">
                <label for="editObservaciones" class="form-label">
                  <i class="bi bi-chat-text me-1"></i>Observaciones
                </label>
                <textarea class="form-control" id="editObservaciones" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" id="btnActualizarRegistro">
            <i class="bi bi-check-lg me-1"></i>Actualizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script>feather.replace();</script>
  <script src="/src/app.js"></script>

  <script>
    let currentUser = null;
    let empleados = [];
    let registrosAsistencia = [];

    // Configuración de endpoints del backend
    const API_ENDPOINTS = {
      USERS: 'https://mature-romona-obra360-e2712968.koyeb.app/api/users',
      ASISTENCIA: 'https://mature-romona-obra360-e2712968.koyeb.app/api/asistencia'
    };

    // Función auxiliar para obtener el token de autenticación
    function getAuthToken() {
      let token = null;
      
      if (window.authManager && typeof window.authManager.getToken === 'function') {
        token = window.authManager.getToken();
      }
      
      if (!token) {
        token = localStorage.getItem("obra360_token") ||
                sessionStorage.getItem("obra360_token") ||
                localStorage.getItem("token") || 
                sessionStorage.getItem("token");
      }
      
      return token;
    }

    // Inicializar página
    document.addEventListener("DOMContentLoaded", function () {
      console.log('🕐 Inicializando Control de Horas...');
      
      // Verificar autenticación
      if (!window.authManager || !window.authManager.isAuthenticated()) {
        window.location.href = '/html/auth/login.html';
        return;
      }

      currentUser = window.authManager.getUser();
      
      if (!currentUser) {
        showAlert('Error al obtener información del usuario. Por favor, inicie sesión nuevamente.', 'danger');
        setTimeout(() => window.location.href = '/html/auth/login.html', 2000);
        return;
      }

      console.log('👤 Usuario actual:', currentUser);

      // Configurar información del usuario
      setupUserInfo();
      
      // Configurar fecha por defecto (hoy)
      setupDefaultDate();
      
      // Configurar event listeners
      setupEventListeners();
      
      // Cargar datos iniciales
      loadInitialData();
      
      // Actualizar hora actual cada segundo
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
    });

    // Configurar información del usuario
    function setupUserInfo() {
      const userName = document.getElementById('userName');
      if (userName && currentUser) {
        userName.textContent = `${currentUser.firstName} ${currentUser.lastName}` || currentUser.email;
      }
    }

    // Configurar fecha por defecto
    function setupDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('fechaFiltro').value = today;
      document.getElementById('registroFecha').value = today;
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Filtros
      document.getElementById('fechaFiltro').addEventListener('change', filtrarRegistros);
      document.getElementById('empleadoFiltro').addEventListener('change', filtrarRegistros);

      // Botón guardar registro
      document.getElementById('btnGuardarRegistro').addEventListener('click', guardarRegistro);
      
      // Botón actualizar registro
      document.getElementById('btnActualizarRegistro').addEventListener('click', actualizarRegistro);

      // Auto-completar hora actual en modal
      document.getElementById('tipoRegistro').addEventListener('change', function() {
        const ahora = new Date();
        const horaActual = ahora.toTimeString().slice(0, 5);
        document.getElementById('registroHora').value = horaActual;
      });
    }

    // Cargar datos iniciales
    async function loadInitialData() {
      try {
        await loadEmpleados();
        await loadRegistrosAsistencia();
        updateResumenDia();
      } catch (error) {
        console.error('Error cargando datos iniciales:', error);
        showAlert('Error al cargar los datos iniciales', 'danger');
      }
    }

    // Cargar empleados
    async function loadEmpleados() {
      try {
        const token = getAuthToken();
        const response = await fetch(API_ENDPOINTS.USERS, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          empleados = await response.json();
          populateEmpleadoSelects();
          console.log(`✅ ${empleados.length} empleados cargados`);
        } else {
          throw new Error('Error al cargar empleados');
        }
      } catch (error) {
        console.error('Error cargando empleados:', error);
        showAlert('Error al cargar la lista de empleados', 'warning');
      }
    }

    // Poblar selects de empleados
    function populateEmpleadoSelects() {
      const empleadoFiltro = document.getElementById('empleadoFiltro');
      const registroEmpleado = document.getElementById('registroEmpleado');

      // Limpiar opciones existentes (excepto la primera)
      empleadoFiltro.innerHTML = '<option value="">Todos los empleados</option>';
      registroEmpleado.innerHTML = '<option value="">Seleccionar empleado</option>';

      empleados.forEach(empleado => {
        const nombreCompleto = `${empleado.firstName} ${empleado.lastName}`;
        
        // Para filtro
        const optionFiltro = document.createElement('option');
        optionFiltro.value = empleado.id;
        optionFiltro.textContent = nombreCompleto;
        empleadoFiltro.appendChild(optionFiltro);

        // Para registro
        const optionRegistro = document.createElement('option');
        optionRegistro.value = empleado.id;
        optionRegistro.textContent = nombreCompleto;
        registroEmpleado.appendChild(optionRegistro);
      });
    }

    // Cargar registros de asistencia del backend
    async function loadRegistrosAsistencia() {
      try {
        const fechaFiltro = document.getElementById('fechaFiltro').value;
        const empleadoFiltro = document.getElementById('empleadoFiltro').value;
        
        // Construir URL con parámetros
        const params = new URLSearchParams();
        if (fechaFiltro) params.append('fecha', fechaFiltro);
        if (empleadoFiltro) params.append('userId', empleadoFiltro);
        
        const url = `${API_ENDPOINTS.ASISTENCIA}?${params.toString()}`;
        
        const token = getAuthToken();
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          registrosAsistencia = await response.json();
          renderRegistros();
          console.log(`✅ ${registrosAsistencia.length} registros de asistencia cargados`);
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Error al cargar registros');
        }
      } catch (error) {
        console.error('Error cargando registros:', error);
        showAlert('Error al cargar los registros de asistencia: ' + error.message, 'danger');
        
        // Mostrar estado vacío en caso de error
        registrosAsistencia = [];
        renderRegistros();
      }
    }

    // Renderizar registros en la tabla
    function renderRegistros() {
      const tbody = document.getElementById('tablaAsistencia');
      
      if (registrosAsistencia.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-clipboard-x" style="font-size: 3rem; color: #6c757d;"></i>
              <p class="mt-3 text-muted">No hay registros de asistencia para mostrar</p>
              <button class="btn btn-primary" onclick="mostrarModalRegistro()">
                <i class="bi bi-plus-lg me-1"></i>Agregar Primer Registro
              </button>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = registrosAsistencia.map(registro => {
        const empleado = empleados.find(e => e.id === registro.empleadoId);
        const nombreEmpleado = empleado ? `${empleado.firstName} ${empleado.lastName}` : registro.empleadoNombre;
        
        // Determinar color para horas extra
        const horasExtraColor = parseFloat(registro.horasExtra.replace(':', '.')) > 0 ? 'text-warning' : 'text-muted';
        
        // Estado del registro
        const tieneEntrada = registro.horaEntrada && registro.horaEntrada !== '--:--:--';
        const tieneSalida = registro.horaSalida && registro.horaSalida !== '--:--:--';
        let estadoBadge = '';
        
        if (tieneEntrada && tieneSalida) {
          estadoBadge = '<span class="badge bg-success ms-2">Completo</span>';
        } else if (tieneEntrada) {
          estadoBadge = '<span class="badge bg-warning ms-2">En progreso</span>';
        } else {
          estadoBadge = '<span class="badge bg-secondary ms-2">Sin registrar</span>';
        }

        return `
          <tr>
            <td class="px-3">
              <div class="d-flex align-items-center">
                <div class="avatar bg-primary text-white rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-person"></i>
                </div>
                <div>
                  <div class="fw-bold">${nombreEmpleado}</div>
                  <div class="text-muted small">${estadoBadge}</div>
                </div>
              </div>
            </td>
            <td class="text-center">
              <span class="badge bg-light text-dark">${formatDate(registro.fecha)}</span>
            </td>
            <td class="text-center">
              <span class="fw-bold ${tieneEntrada ? 'text-success' : 'text-muted'}">
                ${registro.horaEntrada || '--:--:--'}
              </span>
            </td>
            <td class="text-center">
              <span class="fw-bold ${tieneSalida ? 'text-danger' : 'text-muted'}">
                ${registro.horaSalida || '--:--:--'}
              </span>
            </td>
            <td class="text-center">
              <span class="fw-bold text-primary">${registro.horasNormales || '0:00:00'}</span>
            </td>
            <td class="text-center">
              <span class="fw-bold ${horasExtraColor}">${registro.horasExtra || '0:00:00'}</span>
            </td>
            <td class="text-center">
              <span class="fw-bold text-info">${registro.horasTotales || '0:00:00'}</span>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-warning" onclick="editarRegistro('${registro.id}')" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="eliminarRegistro('${registro.id}')" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Filtrar registros
    function filtrarRegistros() {
      const fechaFiltro = document.getElementById('fechaFiltro').value;
      const empleadoFiltro = document.getElementById('empleadoFiltro').value;

      let registrosFiltrados = [...registrosAsistencia];

      if (fechaFiltro) {
        registrosFiltrados = registrosFiltrados.filter(r => r.fecha === fechaFiltro);
      }

      if (empleadoFiltro) {
        registrosFiltrados = registrosFiltrados.filter(r => r.empleadoId === empleadoFiltro);
      }

      // Temporalmente modificar registrosAsistencia para renderizar
      const registrosOriginales = [...registrosAsistencia];
      registrosAsistencia = registrosFiltrados;
      renderRegistros();
      registrosAsistencia = registrosOriginales;

      updateResumenDia();
    }

    // Actualizar resumen del día con datos del backend
    async function updateResumenDia() {
      try {
        const fechaActual = document.getElementById('fechaFiltro').value;
        
        const token = getAuthToken();
        const response = await fetch(`${API_ENDPOINTS.ASISTENCIA}/resumen/${fechaActual}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const resumen = await response.json();
          
          document.getElementById('empleadosPresentes').textContent = resumen.empleadosPresentes || 0;
          document.getElementById('horasTotales').textContent = resumen.horasTotales || '0:00';
          document.getElementById('horasExtra').textContent = resumen.horasExtra || '0:00';
        } else {
          // Fallback a cálculo local si no hay endpoint de resumen
          const fechaActual = document.getElementById('fechaFiltro').value;
          const registrosHoy = registrosAsistencia.filter(r => r.fecha === fechaActual);

          const empleadosPresentes = registrosHoy.filter(r => r.horaEntrada && r.horaEntrada !== '--:--:--').length;
          
          let totalHoras = 0;
          let totalHorasExtra = 0;

          registrosHoy.forEach(registro => {
            if (registro.horasTotales) {
              totalHoras += timeToMinutes(registro.horasTotales);
            }
            if (registro.horasExtra) {
              totalHorasExtra += timeToMinutes(registro.horasExtra);
            }
          });

          document.getElementById('empleadosPresentes').textContent = empleadosPresentes;
          document.getElementById('horasTotales').textContent = minutesToTime(totalHoras);
          document.getElementById('horasExtra').textContent = minutesToTime(totalHorasExtra);
        }
      } catch (error) {
        console.error('Error actualizando resumen:', error);
        // Mantener valores actuales en caso de error
      }
    }

    // Utilidades para tiempo
    function timeToMinutes(timeString) {
      if (!timeString || timeString === '0:00:00') return 0;
      const parts = timeString.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    function minutesToTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}:${mins.toString().padStart(2, '0')}`;
    }

    // Formatear fecha
    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Actualizar hora actual
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('es-ES', { hour12: false });
      const horaActualEl = document.getElementById('horaActual');
      if (horaActualEl) {
        horaActualEl.textContent = timeString;
      }
    }

    // Mostrar modal de registro
    function mostrarModalRegistro() {
      const modal = new bootstrap.Modal(document.getElementById('registroModal'));
      
      // Limpiar formulario
      document.getElementById('registroForm').reset();
      document.getElementById('registroFecha').value = new Date().toISOString().split('T')[0];
      document.getElementById('modalAlertContainer').innerHTML = '';
      
      // Limpiar validaciones
      const inputs = document.querySelectorAll('#registroForm .form-control, #registroForm .form-select');
      inputs.forEach(input => input.classList.remove('is-valid', 'is-invalid'));
      
      modal.show();
    }

    // Guardar registro
    async function guardarRegistro() {
      const btnGuardar = document.getElementById('btnGuardarRegistro');
      const originalText = btnGuardar.innerHTML;

      try {
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Guardando...';

        // Validar formulario
        const empleadoId = document.getElementById('registroEmpleado').value;
        const fecha = document.getElementById('registroFecha').value;
        const tipo = document.getElementById('tipoRegistro').value;
        const hora = document.getElementById('registroHora').value;
        const observaciones = document.getElementById('observaciones').value;

        if (!empleadoId || !fecha || !tipo || !hora) {
          showModalAlert('Por favor complete todos los campos obligatorios', 'warning');
          return;
        }

        // Preparar datos
        const registroData = {
          userId: empleadoId,
          fecha: fecha,
          tipo: tipo,
          hora: hora + ':00', // Agregar segundos
          observaciones: observaciones.trim() || null
        };

        console.log('📤 Enviando registro:', registroData);

        const token = getAuthToken();
        const response = await fetch(`${API_ENDPOINTS.ASISTENCIA}/marcar`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(registroData)
        });

        const result = await response.json();

        if (response.ok) {
          showModalAlert(result.message || 'Registro guardado correctamente', 'success');
          
          // Cerrar modal después de un momento
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('registroModal'));
            modal.hide();
            loadRegistrosAsistencia(); // Recargar datos
            updateResumenDia();
          }, 1500);
        } else {
          throw new Error(result.error || 'Error al guardar el registro');
        }

      } catch (error) {
        console.error('❌ Error guardando registro:', error);
        showModalAlert(error.message || 'Error al guardar el registro', 'danger');
      } finally {
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = originalText;
      }
    }

    // Editar registro
    async function editarRegistro(registroId) {
      const registro = registrosAsistencia.find(r => r.id === registroId);
      if (!registro) {
        showAlert('Registro no encontrado', 'danger');
        return;
      }

      console.log('✏️ Editando registro:', registro);

      // Llenar el formulario de edición
      document.getElementById('editRegistroId').value = registro.id;
      document.getElementById('editHoraEntrada').value = registro.horaEntrada ? registro.horaEntrada.slice(0, 5) : '';
      document.getElementById('editHoraSalida').value = registro.horaSalida ? registro.horaSalida.slice(0, 5) : '';
      document.getElementById('editObservaciones').value = registro.observaciones || '';

      // Limpiar alertas y validaciones
      document.getElementById('editModalAlertContainer').innerHTML = '';
      const inputs = document.querySelectorAll('#editarForm .form-control');
      inputs.forEach(input => input.classList.remove('is-valid', 'is-invalid'));

      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('editarModal'));
      modal.show();
    }

    // Actualizar registro
    async function actualizarRegistro() {
      const btnActualizar = document.getElementById('btnActualizarRegistro');
      const originalText = btnActualizar.innerHTML;

      try {
        btnActualizar.disabled = true;
        btnActualizar.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Actualizando...';

        const registroId = document.getElementById('editRegistroId').value;
        const horaEntrada = document.getElementById('editHoraEntrada').value;
        const horaSalida = document.getElementById('editHoraSalida').value;
        const observaciones = document.getElementById('editObservaciones').value;

        // Preparar datos (solo enviar campos que tienen valor)
        const updateData = {};
        
        if (horaEntrada) updateData.horaEntrada = horaEntrada + ':00';
        if (horaSalida) updateData.horaSalida = horaSalida + ':00';
        if (observaciones !== undefined) updateData.observaciones = observaciones.trim() || null;

        console.log('📤 Actualizando registro:', registroId, updateData);

        const token = getAuthToken();
        const response = await fetch(`${API_ENDPOINTS.ASISTENCIA}/${registroId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });

        const result = await response.json();

        if (response.ok) {
          showEditModalAlert(result.message || 'Registro actualizado correctamente', 'success');
          
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editarModal'));
            modal.hide();
            loadRegistrosAsistencia(); // Recargar datos
            updateResumenDia();
          }, 1500);
        } else {
          throw new Error(result.error || 'Error al actualizar el registro');
        }

      } catch (error) {
        console.error('❌ Error actualizando registro:', error);
        showEditModalAlert(error.message || 'Error al actualizar el registro', 'danger');
      } finally {
        btnActualizar.disabled = false;
        btnActualizar.innerHTML = originalText;
      }
    }

    // Eliminar registro
    async function eliminarRegistro(registroId) {
      if (!confirm('¿Está seguro que desea eliminar este registro de asistencia?')) {
        return;
      }

      try {
        console.log('🗑️ Eliminando registro:', registroId);

        const token = getAuthToken();
        const response = await fetch(`${API_ENDPOINTS.ASISTENCIA}/${registroId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (response.ok) {
          showAlert(result.message || 'Registro eliminado correctamente', 'success');
          loadRegistrosAsistencia(); // Recargar datos
          updateResumenDia();
        } else {
          throw new Error(result.error || 'Error al eliminar el registro');
        }

      } catch (error) {
        console.error('❌ Error eliminando registro:', error);
        showAlert(error.message || 'Error al eliminar el registro', 'danger');
      }
    }

    // Exportar a Excel
    function exportarExcel() {
      showAlert('Función de exportación en desarrollo', 'info');
    }

    // Actualizar datos
    function actualizarDatos() {
      loadInitialData();
      showAlert('Datos actualizados correctamente', 'success');
    }

    // Mostrar alertas
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      if (!alertContainer) return;

      const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger', 
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';

      const alertIcon = {
        'success': 'bi-check-circle',
        'danger': 'bi-exclamation-triangle',
        'warning': 'bi-exclamation-triangle',
        'info': 'bi-info-circle'
      }[type] || 'bi-info-circle';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi ${alertIcon} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;

      if (type === 'success') {
        setTimeout(() => {
          const alert = alertContainer.querySelector('.alert');
          if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }
        }, 3000);
      }
    }

    // Mostrar alertas en modal
    function showModalAlert(message, type = 'info') {
      const alertContainer = document.getElementById('modalAlertContainer');
      if (!alertContainer) return;

      const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning', 
        'info': 'alert-info'
      }[type] || 'alert-info';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    // Mostrar alertas en modal de edición
    function showEditModalAlert(message, type = 'info') {
      const alertContainer = document.getElementById('editModalAlertContainer');
      if (!alertContainer) return;

      const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning', 
        'info': 'alert-info'
      }[type] || 'alert-info';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi bi-info-circle me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    // Función global para logout
    function logout() {
      if (window.authManager) {
        window.authManager.logout();
      } else {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/html/auth/login.html';
      }
    }
  </script>
</body>
</html>