<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
  <title>Listado de Personal - Obra 360</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/src/app.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>

<body>
  <script src="/src/js/auth.js"></script>

  <div class="wrapper">
    <nav class="sidebar js-sidebar" id="sidebar">
      <div class="sidebar-content js-simplebar">
        <a class="sidebar-brand" href="/index.html">
          <span class="align-middle">Obra 360</span>
        </a>
        <ul class="sidebar-nav">
          <li class="sidebar-header">Secciones</li>

          <!-- Inicio -->
          <li class="sidebar-item">
            <a class="sidebar-link" href="/index.html">
              <i class="align-middle" data-feather="sliders"></i>
              <span class="align-middle">Inicio</span>
            </a>
          </li>

          <!-- Obras -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-obras" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="home"></i>
              <span class="align-middle">Obras</span>
            </a>
            <ul id="submenu-obras" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/obras/obras.html">Listado de obras</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/obras/nueva-obra.html">Nueva obra</a>
              </li>
            </ul>
          </li>

          <!-- Materiales -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-materiales" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="box"></i>
              <span class="align-middle">Materiales</span>
            </a>
            <ul id="submenu-materiales" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/materiales/materiales.html">Listado de materiales</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/materiales/nuevo-material.html">Nuevo material</a>
              </li>
            </ul>
          </li>

          <!-- Certificaciones -->
          <li class="sidebar-item">
            <a data-bs-target="#submenu-certificaciones" data-bs-toggle="collapse" class="sidebar-link collapsed">
              <i class="align-middle" data-feather="file-text"></i>
              <span class="align-middle">Certificaciones</span>
            </a>
            <ul id="submenu-certificaciones" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/certificaciones/certificaciones.html">Alta de certificaci√≥n</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/certificaciones/certificaciones-nueva.html">Nueva certificaci√≥n</a>
              </li>
            </ul>
          </li>

          <!-- Personal -->
          <li class="sidebar-item active">
            <a data-bs-target="#submenu-personal" data-bs-toggle="collapse" class="sidebar-link">
              <i class="align-middle" data-feather="users"></i>
              <span class="align-middle">Personal</span>
            </a>
            <ul id="submenu-personal" class="sidebar-dropdown list-unstyled collapse show" data-bs-parent="#sidebar">
              <li class="sidebar-item active">
                <a class="sidebar-link" href="/html/personal/personal.html">Listado de personal</a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="/html/personal/nuevo-personal.html">Nuevo ingreso</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <div class="main">
      <nav class="navbar navbar-expand navbar-light navbar-bg">
        <a class="sidebar-toggle js-sidebar-toggle">
          <i class="hamburger align-self-center"></i>
        </a>
        <div class="navbar-collapse collapse">
          <ul class="navbar-nav navbar-align">
            <li class="nav-item dropdown">
              <a class="nav-icon dropdown-toggle" data-bs-toggle="dropdown" href="#" id="alertsDropdown">
                <div class="position-relative">
                  <i class="align-middle" data-feather="bell"></i>
                  <span class="indicator">0</span>
                </div>
              </a>
              <div aria-labelledby="alertsDropdown" class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0">
                <div class="dropdown-menu-header">Sin notificaciones</div>
                <div class="dropdown-menu-footer">
                  <a class="text-muted" href="#">Ver todas las notificaciones</a>
                </div>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" data-bs-toggle="dropdown" href="#">
                <i class="align-middle" data-feather="settings"></i>
              </a>
              <a class="nav-link dropdown-toggle d-none d-sm-inline-block" data-bs-toggle="dropdown" href="#">
                <span class="text-dark" id="userName">Usuario</span>
              </a>
              <div class="dropdown-menu dropdown-menu-end">
                <a class="dropdown-item" href="pages-profile.html">
                  <i class="align-middle me-1" data-feather="user"></i>
                  Profile
                </a>
                <a class="dropdown-item" href="#">
                  <i class="align-middle me-1" data-feather="pie-chart"></i>
                  Analytics
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="/index.html">
                  <i class="align-middle me-1" data-feather="settings"></i>
                  Settings &amp; Privacy
                </a>
                <a class="dropdown-item" href="#">
                  <i class="align-middle me-1" data-feather="help-circle"></i>
                  Help Center
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" onclick="logout()">
                  <i class="align-middle me-1" data-feather="log-out"></i>
                  Cerrar Sesi√≥n
                </a>
              </div>
            </li>
          </ul>
        </div>
      </nav>

      <main class="content">
        <div class="container-fluid p-0">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h3 class="card-title mb-0">
                      <i class="bi bi-people me-2"></i>Listado de Personal
                    </h3>
                    <p class="text-muted mb-0">Gesti√≥n de usuarios y roles del sistema</p>
                  </div>
                  
                  <!-- Bot√≥n para agregar usuario (solo admin/supervisor) -->
                  <div id="boton-alta-usuario" style="display: none;">
                    <a href="/html/personal/nuevo-personal.html" class="btn btn-primary">
                      <i class="bi bi-person-plus me-1"></i>Agregar Usuario
                    </a>
                  </div>
                </div>
                
                <div class="card-body">
                  <!-- Contenedor de alertas -->
                  <div id="alertContainer"></div>
                  
                  <!-- Filtros y b√∫squeda -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <div class="input-group">
                        <span class="input-group-text">
                          <i class="bi bi-search"></i>
                        </span>
                        <input 
                          type="text" 
                          class="form-control" 
                          id="searchInput" 
                          placeholder="Buscar por nombre, email o rol..."
                        />
                      </div>
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" id="roleFilter">
                        <option value="">Todos los roles</option>
                        <option value="ADMIN">Administradores</option>
                        <option value="SUPERVISOR">Supervisores</option>
                        <option value="OPERATOR,OPERARIO">Operadores</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-secondary" onclick="refreshUserList()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                      </button>
                    </div>
                  </div>

                  <!-- Tabla de usuarios -->
                  <div class="table-responsive">
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th>
                            <i class="bi bi-person me-1"></i>Usuario
                          </th>
                          <th>
                            <i class="bi bi-envelope me-1"></i>Email
                          </th>
                          <th>
                            <i class="bi bi-shield me-1"></i>Rol
                          </th>
                          <th>
                            <i class="bi bi-calendar me-1"></i>Registro
                          </th>
                          <th class="text-center" id="actionsHeader" style="display: none;">
                            <i class="bi bi-gear me-1"></i>Acciones
                          </th>
                        </tr>
                      </thead>
                      <tbody id="usersTableBody">
                        <tr>
                          <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando usuarios...</p>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Paginaci√≥n -->
                  <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                      <span class="text-muted" id="userCount">0 usuarios encontrados</span>
                    </div>
                    <nav aria-label="Paginaci√≥n de usuarios">
                      <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- Se generar√° din√°micamente -->
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="container-fluid">
          <div class="row text-muted">
            <div class="col-6 text-start">
              <p class="mb-0">
                <a class="text-muted" target="_blank">
                  <strong>Obra 360</strong>
                </a>
                -
                <a class="text-muted" target="_blank">
                  <strong>Admin Kit</strong>
                </a>
                ¬©
              </p>
            </div>
            <div class="col-6 text-end">
              <ul class="list-inline">
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Soporte</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Centro de ayuda</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">Privacidad</a>
                </li>
                <li class="list-inline-item">
                  <a class="text-muted" href="" target="_blank">T√©rminos</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal para confirmar eliminaci√≥n -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirmar Eliminaci√≥n
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¬øEst√° seguro que desea eliminar al usuario <strong id="deleteUserName"></strong>?</p>
          <p class="text-muted small">Esta acci√≥n no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash me-1"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar usuario -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">
            <i class="bi bi-pencil text-primary me-2"></i>Editar Usuario
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Contenedor de alertas del modal -->
          <div id="editAlertContainer"></div>
          
          <form id="editUserForm">
            <input type="hidden" id="editUserId" />
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editFirstName" class="form-label">
                  <i class="bi bi-person me-1"></i>Nombre *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="editFirstName" 
                  required 
                />
                <div class="invalid-feedback">El nombre es requerido.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="editLastName" class="form-label">
                  <i class="bi bi-person me-1"></i>Apellido *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="editLastName" 
                  required 
                />
                <div class="invalid-feedback">El apellido es requerido.</div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editEmail" class="form-label">
                  <i class="bi bi-envelope me-1"></i>Email *
                </label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="editEmail" 
                  required 
                />
                <div class="invalid-feedback">Ingrese un email v√°lido.</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="editRole" class="form-label">
                  <i class="bi bi-shield me-1"></i>Rol *
                </label>
                <select class="form-select" id="editRole" required>
                  <option value="">Seleccionar rol</option>
                  <option value="ADMIN">Administrador</option>
                  <option value="SUPERVISOR">Supervisor</option>
                  <option value="OPERATOR">Operador</option>
                </select>
                <div class="invalid-feedback">Debe seleccionar un rol.</div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="changePassword"
                  />
                  <label class="form-check-label" for="changePassword">
                    <i class="bi bi-key me-1"></i>Cambiar contrase√±a
                  </label>
                </div>
              </div>
            </div>

            <div class="row" id="passwordSection" style="display: none;">
              <div class="col-12 mt-3">
                <label for="editPassword" class="form-label">
                  <i class="bi bi-lock me-1"></i>Nueva Contrase√±a
                </label>
                <div class="input-group">
                  <input 
                    type="password" 
                    class="form-control" 
                    id="editPassword" 
                    minlength="8"
                    placeholder="M√≠nimo 8 caracteres"
                  />
                  <button class="btn btn-outline-secondary" type="button" id="toggleEditPassword">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="invalid-feedback">La contrase√±a debe tener al menos 8 caracteres.</div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="saveUserBtn">
            <i class="bi bi-check-lg me-1"></i>Guardar Cambios
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script>feather.replace();</script>
  <script src="/src/app.js"></script>

  <script>
    // Configuraci√≥n de endpoints del backend
    const API_ENDPOINTS = {
      LIST_USERS: 'https://mature-romona-obra360-e2712968.koyeb.app/api/users',
      UPDATE_USER: 'https://mature-romona-obra360-e2712968.koyeb.app/api/users', // Probaremos con /api/users primero
      DELETE_USER: 'https://mature-romona-obra360-e2712968.koyeb.app/api/users'  // Y tambi√©n para DELETE
    };

    let currentUser = null;
    let allUsers = [];
    let filteredUsers = [];
    let currentPage = 1;
    const usersPerPage = 10;

    // Funci√≥n auxiliar para obtener el token de autenticaci√≥n
    function getAuthToken() {
      let token = null;
      
      // Opci√≥n 1: authManager (preferida)
      if (window.authManager && typeof window.authManager.getToken === 'function') {
        token = window.authManager.getToken();
      }
      
      // Opci√≥n 2: localStorage/sessionStorage con diferentes nombres
      if (!token) {
        token = localStorage.getItem("obra360_token") ||      // ‚Üê El nombre correcto
                sessionStorage.getItem("obra360_token") ||
                localStorage.getItem("token") || 
                sessionStorage.getItem("token") ||
                localStorage.getItem("authToken") ||
                sessionStorage.getItem("authToken");
      }
      
      return token;
    }

    // Inicializar p√°gina
    document.addEventListener("DOMContentLoaded", function () {
      console.log('üîÑ Inicializando p√°gina de personal...');
      
      // Verificar autenticaci√≥n usando el authManager
      if (!window.authManager || !window.authManager.isAuthenticated()) {
        console.log('‚ùå Usuario no autenticado');
        window.location.href = '/html/auth/login.html';
        return;
      }

      // Obtener usuario actual usando authManager
      currentUser = window.authManager.getUser();
      console.log('üë§ Usuario actual:', currentUser);

      if (!currentUser) {
        console.log('‚ùå No se pudo obtener informaci√≥n del usuario');
        showAlert('Error al obtener informaci√≥n del usuario. Por favor, inicie sesi√≥n nuevamente.', 'danger');
        setTimeout(() => window.location.href = '/html/auth/login.html', 2000);
        return;
      }

      // Verificar permisos - Admin y Supervisor pueden ver el listado
      if (currentUser.role !== "ADMIN" && currentUser.role !== "SUPERVISOR") {
        console.log('‚ùå Usuario sin permisos:', currentUser.role);
        showAlert("Acceso denegado. Solo administradores y supervisores pueden ver el listado de personal.", "danger");
        setTimeout(() => window.location.href = "/index.html", 2000);
        return;
      }

      console.log('‚úÖ Usuario autorizado:', currentUser.role);

      // Mostrar informaci√≥n del usuario
      setupUserInfo();
      
      // Mostrar controles seg√∫n permisos
      setupUserControls();
      
      // Configurar event listeners
      setupEventListeners();
      
      // Configurar modales
      setupModals();
      
      // Cargar usuarios
      loadUsers();
    });

    // Configurar modales
    function setupModals() {
      // Toggle para cambiar contrase√±a en modal de edici√≥n
      const changePasswordCheck = document.getElementById('changePassword');
      const passwordSection = document.getElementById('passwordSection');
      const editPassword = document.getElementById('editPassword');
      
      if (changePasswordCheck && passwordSection && editPassword) {
        changePasswordCheck.addEventListener('change', function() {
          if (this.checked) {
            passwordSection.style.display = 'block';
            editPassword.setAttribute('required', 'required');
          } else {
            passwordSection.style.display = 'none';
            editPassword.removeAttribute('required');
            editPassword.value = '';
          }
        });
      }

      // Toggle para mostrar/ocultar contrase√±a en modal de edici√≥n
      const toggleEditPassword = document.getElementById('toggleEditPassword');
      const editPasswordInput = document.getElementById('editPassword');
      
      if (toggleEditPassword && editPasswordInput) {
        toggleEditPassword.addEventListener('click', function() {
          const type = editPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          editPasswordInput.setAttribute('type', type);
          
          const icon = this.querySelector('i');
          icon.classList.toggle('bi-eye');
          icon.classList.toggle('bi-eye-slash');
        });
      }

      // Guardar cambios del usuario
      const saveUserBtn = document.getElementById('saveUserBtn');
      if (saveUserBtn) {
        saveUserBtn.addEventListener('click', saveUserChanges);
      }

      // Validaci√≥n en tiempo real en modal de edici√≥n
      const editInputs = document.querySelectorAll('#editUserForm input, #editUserForm select');
      editInputs.forEach(input => {
        input.addEventListener('blur', validateEditInput);
        input.addEventListener('input', clearEditValidation);
      });
    }

    // Configurar informaci√≥n del usuario
    function setupUserInfo() {
      const userName = document.getElementById('userName');
      if (userName && currentUser) {
        userName.textContent = `${currentUser.firstName} ${currentUser.lastName}` || currentUser.email;
      }
    }

    // Configurar controles seg√∫n el rol del usuario
    function setupUserControls() {
      // Solo admin y supervisor pueden crear usuarios
      if (currentUser.role === "ADMIN" || currentUser.role === "SUPERVISOR") {
        const botonAlta = document.getElementById("boton-alta-usuario");
        const actionsHeader = document.getElementById("actionsHeader");
        
        if (botonAlta) botonAlta.style.display = "block";
        if (actionsHeader) actionsHeader.style.display = "table-cell";
      }
    }

    // Configurar event listeners
    function setupEventListeners() {
      // B√∫squeda en tiempo real
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(filterUsers, 300));
      }

      // Filtro por rol
      const roleFilter = document.getElementById('roleFilter');
      if (roleFilter) {
        roleFilter.addEventListener('change', filterUsers);
      }
    }

    // Cargar usuarios del backend
    async function loadUsers() {
      try {
        console.log('üì• Cargando usuarios...');
        
        const token = getAuthToken();
        console.log('üîë Token obtenido:', token ? '‚úÖ Encontrado' : '‚ùå No encontrado');
        
        if (!token) {
          throw new Error('No se pudo encontrar el token de autenticaci√≥n');
        }

        const response = await fetch(API_ENDPOINTS.LIST_USERS, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('üìã Usuarios recibidos:', result);

        // Manejar diferentes formatos de respuesta del backend
        let users = [];
        
        if (Array.isArray(result)) {
          // Formato directo: [user1, user2, user3]
          users = result;
          console.log('‚úÖ Formato de array directo detectado');
        } else if (result && result.success && result.data) {
          // Formato wrapper: {success: true, data: [user1, user2, user3]}
          users = result.data;
          console.log('‚úÖ Formato wrapper detectado');
        } else if (result && Array.isArray(result.users)) {
          // Formato alternativo: {users: [user1, user2, user3]}
          users = result.users;
          console.log('‚úÖ Formato users array detectado');
        } else {
          throw new Error(result?.error || 'Formato de respuesta inesperado');
        }

        if (users && users.length >= 0) {
          allUsers = users;
          filteredUsers = [...allUsers];
          renderUsers();
          updateUserCount();
          console.log(`‚úÖ ${users.length} usuarios cargados correctamente`);
        } else {
          throw new Error('No se encontraron usuarios o formato inv√°lido');
        }

      } catch (error) {
        console.error('‚ùå Error cargando usuarios:', error);
        showAlert('Error al cargar la lista de usuarios. Intente nuevamente.', 'danger');
        renderEmptyState('Error al cargar usuarios');
      }
    }

    // Filtrar usuarios
    function filterUsers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;

      filteredUsers = allUsers.filter(user => {
        const matchesSearch = 
          (user.firstName || '').toLowerCase().includes(searchTerm) ||
          (user.lastName || '').toLowerCase().includes(searchTerm) ||
          (user.email || '').toLowerCase().includes(searchTerm) ||
          (user.role || '').toLowerCase().includes(searchTerm);

        // Manejar filtro de roles (incluyendo m√∫ltiples roles para operadores)
        let matchesRole = true;
        if (roleFilter) {
          const allowedRoles = roleFilter.split(',');
          matchesRole = allowedRoles.includes(user.role);
        }

        return matchesSearch && matchesRole;
      });

      currentPage = 1;
      renderUsers();
      updateUserCount();
    }

    // Renderizar usuarios en la tabla
    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) return;

      if (filteredUsers.length === 0) {
        renderEmptyState('No se encontraron usuarios');
        return;
      }

      const startIndex = (currentPage - 1) * usersPerPage;
      const endIndex = startIndex + usersPerPage;
      const currentUsers = filteredUsers.slice(startIndex, endIndex);

      tbody.innerHTML = currentUsers.map(user => {
        const canDelete = canDeleteUser(user);
        const roleInfo = getRoleInfo(user.role);
        
        // Valores por defecto para campos que pueden faltar
        const firstName = user.firstName || 'Sin nombre';
        const lastName = user.lastName || 'Sin apellido';
        const email = user.email || 'Sin email';
        const userId = user.id || 'Sin ID';
        
        return `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar bg-${roleInfo.color} text-white rounded-circle me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                  <i class="bi ${roleInfo.icon}"></i>
                </div>
                <div>
                  <div class="fw-bold">${firstName} ${lastName}</div>
                  <div class="text-muted small">ID: ${userId}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="text-primary">${email}</span>
            </td>
            <td>
              <span class="badge bg-${roleInfo.color}">${roleInfo.name}</span>
            </td>
            <td>
              <span class="text-muted">${formatDate(user.createdAt || user.created_at)}</span>
            </td>
            ${(currentUser.role === "ADMIN" || currentUser.role === "SUPERVISOR") ? `
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-primary" onclick="editUser('${userId}')" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  ${canDelete ? `
                    <button class="btn btn-outline-danger" onclick="confirmDeleteUser('${userId}', '${firstName} ${lastName}')" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : `
                    <button class="btn btn-outline-secondary" disabled title="No se puede eliminar">
                      <i class="bi bi-shield-check"></i>
                    </button>
                  `}
                </div>
              </td>
            ` : ''}
          </tr>
        `;
      }).join('');

      renderPagination();
    }

    // Renderizar estado vac√≠o
    function renderEmptyState(message) {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) return;

      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-5">
            <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
            <p class="mt-3 text-muted">${message}</p>
            ${message.includes('Error') ? `
              <button class="btn btn-outline-primary" onclick="loadUsers()">
                <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
              </button>
            ` : ''}
          </td>
        </tr>
      `;
    }

    // Obtener informaci√≥n del rol
    function getRoleInfo(role) {
      const roles = {
        'ADMIN': { name: 'Administrador', color: 'danger', icon: 'bi-shield-fill' },
        'SUPERVISOR': { name: 'Supervisor', color: 'warning', icon: 'bi-eye-fill' },
        'OPERATOR': { name: 'Operador', color: 'secondary', icon: 'bi-person-fill' },
        'OPERARIO': { name: 'Operador', color: 'secondary', icon: 'bi-person-fill' } // ‚Üê Compatibilidad backend
      };
      return roles[role] || { name: role, color: 'secondary', icon: 'bi-person' };
    }

    // Verificar si se puede eliminar un usuario
    function canDeleteUser(user) {
      // Administradores pueden eliminar cualquiera excepto a s√≠ mismos
      if (currentUser.role === "ADMIN") {
        return user.id !== currentUser.id;
      }
      
      // Supervisores pueden eliminar solo operadores
      if (currentUser.role === "SUPERVISOR") {
        return user.role === "OPERATOR" || user.role === "OPERARIO"; // ‚Üê Compatibilidad backend
      }
      
      return false;
    }

    // Validar email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Formatear fecha
    function formatDate(dateString) {
      if (!dateString) return 'Sin fecha';
      const date = new Date(dateString);
      return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Actualizar contador de usuarios
    function updateUserCount() {
      const userCount = document.getElementById('userCount');
      if (userCount) {
        userCount.textContent = `${filteredUsers.length} usuario${filteredUsers.length !== 1 ? 's' : ''} encontrado${filteredUsers.length !== 1 ? 's' : ''}`;
      }
    }

    // Renderizar paginaci√≥n
    function renderPagination() {
      const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
      const pagination = document.getElementById('pagination');
      
      if (!pagination || totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';
      
      // Bot√≥n anterior
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
        </li>
      `;

      // P√°ginas
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }

      // Bot√≥n siguiente
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Siguiente</a>
        </li>
      `;

      pagination.innerHTML = paginationHTML;
    }

    // Cambiar p√°gina
    function changePage(page) {
      const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderUsers();
      }
    }

    // Confirmar eliminaci√≥n de usuario
    function confirmDeleteUser(userId, userName) {
      console.log('üîç Confirmando eliminaci√≥n:', userId, userName);
      
      const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
      document.getElementById('deleteUserName').textContent = userName;
      
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      // Remover event listeners previos para evitar duplicados
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      
      // Agregar nuevo event listener
      newConfirmBtn.addEventListener('click', () => deleteUser(userId, modal));
      
      modal.show();
    }

    // Eliminar usuario
    async function deleteUser(userId, modal) {
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const originalText = confirmBtn.innerHTML;

      try {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Eliminando...';

        const token = getAuthToken();
        const response = await fetch(`https://mature-romona-obra360-e2712968.koyeb.app/api/users/${userId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (response.ok) {
          showAlert('Usuario eliminado correctamente', 'success');
          modal.hide();
          loadUsers(); // Recargar lista
        } else {
          const result = await response.json();
          throw new Error(result.error || 'Error al eliminar usuario');
        }

      } catch (error) {
        console.error('Error eliminando usuario:', error);
        showAlert(error.message || 'Error al eliminar usuario', 'danger');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
      }
    }

    // Editar usuario
    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) {
        showAlert('Usuario no encontrado', 'danger');
        return;
      }

      console.log('‚úèÔ∏è Editando usuario:', user);

      // Llenar el formulario con los datos actuales
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editFirstName').value = user.firstName || '';
      document.getElementById('editLastName').value = user.lastName || '';
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editRole').value = user.role || '';

      // Configurar restricciones de rol seg√∫n el usuario actual
      const editRoleSelect = document.getElementById('editRole');
      const adminOption = editRoleSelect.querySelector('option[value="ADMIN"]');
      
      // Si es supervisor, no puede crear/editar administradores
      if (currentUser.role === "SUPERVISOR") {
        if (adminOption) adminOption.style.display = 'none';
        
        // Tampoco puede editar otros supervisores o admins para cambiarles el rol
        if (user.role === 'ADMIN' || user.role === 'SUPERVISOR') {
          editRoleSelect.disabled = true;
          showEditAlert('Como supervisor, no puedes cambiar el rol de administradores o supervisores', 'warning');
        } else {
          editRoleSelect.disabled = false;
        }
      } else if (adminOption) {
        adminOption.style.display = 'block';
        editRoleSelect.disabled = false;
      }

      // Reset del formulario
      const form = document.getElementById('editUserForm');
      const inputs = form.querySelectorAll('.form-control, .form-select');
      inputs.forEach(input => {
        input.classList.remove('is-valid', 'is-invalid');
      });

      // Reset de la secci√≥n de contrase√±a
      document.getElementById('changePassword').checked = false;
      document.getElementById('passwordSection').style.display = 'none';
      document.getElementById('editPassword').removeAttribute('required');
      document.getElementById('editPassword').value = '';

      // Limpiar alertas
      document.getElementById('editAlertContainer').innerHTML = '';

      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Guardar cambios del usuario
    async function saveUserChanges() {
      const saveBtn = document.getElementById('saveUserBtn');
      const originalText = saveBtn.innerHTML;

      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Guardando...';

        // Validar formulario
        if (!validateEditForm()) {
          return;
        }

        const userId = document.getElementById('editUserId').value;
        const changePassword = document.getElementById('changePassword').checked;

        // Preparar datos
        const userData = {
          firstName: document.getElementById('editFirstName').value.trim(),
          lastName: document.getElementById('editLastName').value.trim(),
          email: document.getElementById('editEmail').value.trim(),
          role: document.getElementById('editRole').value
        };

        // Agregar contrase√±a si se va a cambiar
        if (changePassword) {
          const password = document.getElementById('editPassword').value;
          if (password) {
            userData.password = password;
          }
        }

        console.log('üíæ Guardando cambios del usuario:', userId, userData);

        const token = getAuthToken();
        if (!token) {
          throw new Error('No se encontr√≥ token de autenticaci√≥n');
        }

        const updateUrl = `${API_ENDPOINTS.UPDATE_USER}/${userId}`;
        console.log('üåê URL del request:', updateUrl);
        console.log('üì§ Datos enviados:', JSON.stringify(userData, null, 2));

        const response = await fetch(updateUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(userData)
        });

        console.log('üì• Respuesta del servidor:', response.status, response.statusText);

        if (response.ok) {
          // Intentar leer la respuesta exitosa
          let result = null;
          try {
            result = await response.json();
            console.log('‚úÖ Respuesta exitosa:', result);
          } catch (jsonError) {
            console.log('‚ÑπÔ∏è Respuesta exitosa sin JSON');
          }

          showEditAlert('Usuario actualizado correctamente', 'success');
          
          // Cerrar modal despu√©s de un momento
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
            loadUsers(); // Recargar lista
          }, 1500);
        } else {
          // Obtener detalles del error
          let errorMessage = `Error ${response.status}: ${response.statusText}`;
          let errorDetails = null;
          
          try {
            errorDetails = await response.json();
            console.log('‚ùå Detalles del error:', errorDetails);
            errorMessage = errorDetails.error || errorDetails.message || errorMessage;
          } catch (jsonError) {
            console.log('‚ùå Error sin JSON:', errorMessage);
          }

          throw new Error(errorMessage);
        }

      } catch (error) {
        console.error('‚ùå Error actualizando usuario:', error);
        showEditAlert(error.message || 'Error al actualizar usuario', 'danger');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    }

    // Validar formulario de edici√≥n
    function validateEditForm() {
      const requiredFields = [
        { id: 'editFirstName', name: 'Nombre' },
        { id: 'editLastName', name: 'Apellido' },
        { id: 'editEmail', name: 'Email' },
        { id: 'editRole', name: 'Rol' }
      ];

      let isValid = true;

      requiredFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (!input || !input.value.trim()) {
          setEditInputValidation(input, false, `${field.name} es requerido`);
          isValid = false;
        } else {
          setEditInputValidation(input, true);
        }
      });

      // Validar email
      const emailInput = document.getElementById('editEmail');
      if (emailInput && emailInput.value && !isValidEmail(emailInput.value)) {
        setEditInputValidation(emailInput, false, 'Ingrese un email v√°lido');
        isValid = false;
      }

      // Validar contrase√±a si se va a cambiar
      const changePassword = document.getElementById('changePassword').checked;
      if (changePassword) {
        const passwordInput = document.getElementById('editPassword');
        if (passwordInput && (!passwordInput.value || passwordInput.value.length < 8)) {
          setEditInputValidation(passwordInput, false, 'La contrase√±a debe tener al menos 8 caracteres');
          isValid = false;
        }
      }

      if (!isValid) {
        showEditAlert('Por favor complete todos los campos correctamente', 'warning');
      }

      return isValid;
    }

    // Validar input individual en modal de edici√≥n
    function validateEditInput(event) {
      const input = event.target;
      const value = input.value.trim();

      if (input.hasAttribute('required') && !value) {
        setEditInputValidation(input, false, `Este campo es requerido`);
      } else if (input.type === 'email' && value && !isValidEmail(value)) {
        setEditInputValidation(input, false, 'Ingrese un email v√°lido');
      } else if (input.type === 'password' && value && value.length < 8) {
        setEditInputValidation(input, false, 'La contrase√±a debe tener al menos 8 caracteres');
      } else {
        setEditInputValidation(input, true);
      }
    }

    // Limpiar validaci√≥n en modal de edici√≥n
    function clearEditValidation(event) {
      const input = event.target;
      input.classList.remove('is-invalid', 'is-valid');
    }

    // Configurar validaci√≥n visual en modal de edici√≥n
    function setEditInputValidation(input, isValid, message = '') {
      if (isValid) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
      } else {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        
        const feedback = input.parentNode.querySelector('.invalid-feedback');
        if (feedback && message) {
          feedback.textContent = message;
        }
      }
    }

    // Mostrar alertas en el modal de edici√≥n
    function showEditAlert(message, type = 'info') {
      const alertContainer = document.getElementById('editAlertContainer');
      if (!alertContainer) return;

      const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';

      const alertIcon = {
        'success': 'bi-check-circle',
        'danger': 'bi-exclamation-triangle',
        'warning': 'bi-exclamation-triangle',
        'info': 'bi-info-circle'
      }[type] || 'bi-info-circle';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi ${alertIcon} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;

      // Auto-hide success alerts
      if (type === 'success') {
        setTimeout(() => {
          const alert = alertContainer.querySelector('.alert');
          if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }
        }, 3000);
      }
    }

    // Refrescar lista de usuarios
    function refreshUserList() {
      loadUsers();
    }

    // Mostrar alertas
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      if (!alertContainer) return;

      const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';

      const alertIcon = {
        'success': 'bi-check-circle',
        'danger': 'bi-exclamation-triangle',
        'warning': 'bi-exclamation-triangle',
        'info': 'bi-info-circle'
      }[type] || 'bi-info-circle';

      alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi ${alertIcon} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;

      // Auto-hide success alerts
      if (type === 'success') {
        setTimeout(() => {
          const alert = alertContainer.querySelector('.alert');
          if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }
        }, 3000);
      }

      // Scroll para mostrar la alerta
      alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Debounce function para la b√∫squeda
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Funci√≥n global para logout
    function logout() {
      if (window.authManager) {
        window.authManager.logout();
      } else {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/html/auth/login.html';
      }
    }
  </script>
</body>
</html>